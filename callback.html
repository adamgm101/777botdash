<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Discord Authentication - معالجة المصادقة</title>
    <style>
        body {
            font-family: 'Cairo', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #0a0d12 0%, #1a1f2e 100%);
            color: #e6f1ff;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .callback-container {
            text-align: center;
            padding: 40px;
            background: rgba(15, 20, 27, 0.95);
            border-radius: 20px;
            border: 1px solid #1b2433;
            backdrop-filter: blur(20px);
            max-width: 400px;
            width: 90%;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #1b2433;
            border-top: 4px solid #00e5ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        h2 {
            color: #e6f1ff;
            margin-bottom: 16px;
        }
        
        p {
            color: #93a4bf;
            margin-bottom: 20px;
        }
        
        .error {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .success {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
    </style>
</head>
<body>
    <div class="callback-container">
        <div id="loading" class="loading-state">
            <div class="spinner"></div>
            <h2>جاري معالجة المصادقة...</h2>
            <p>يرجى الانتظار بينما نعالج تسجيل الدخول الخاص بك</p>
        </div>
        
        <div id="error" class="error-state" style="display: none;">
            <h2>❌ فشل في المصادقة</h2>
            <p id="error-message">حدث خطأ أثناء تسجيل الدخول</p>
            <div style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;">
                <button onclick="window.close()" style="
                    background: #6b7280;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                ">إغلاق النافذة</button>
                <button onclick="retryAuth()" style="
                    background: #3b82f6;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                ">إعادة المحاولة</button>
            </div>
        </div>
        
        <div id="success" class="success-state" style="display: none;">
            <h2>✅ تم تسجيل الدخول بنجاح</h2>
            <p>سيتم إغلاق هذه النافذة تلقائياً</p>
        </div>
    </div>

    <script>
        // Discord OAuth2 Configuration (should match main app)
        const DISCORD_CONFIG = {
            clientId: '1399499840475500574', // Client ID الخاص بك
            clientSecret: 'P7RHo2yhr0Is2Yc5gPf78Odlgtkj0N7f', // Client Secret الخاص بك
            redirectUri: window.location.origin + '/callback.html', // سيعمل تلقائياً مع Netlify
            scopes: ['identify', 'guilds'],
            apiBase: 'https://discord.com/api/v10'
        };

        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const error = urlParams.get('error');
        const errorDescription = urlParams.get('error_description');

        // Handle OAuth callback
        async function handleCallback() {
            try {
                console.log('Callback received:', { code: code ? 'present' : 'missing', state: state ? 'present' : 'missing', error });
                
                // Check for OAuth errors
                if (error) {
                    throw new Error(errorDescription || error);
                }

                if (!code) {
                    throw new Error('لم يتم الحصول على رمز المصادقة');
                }

                if (!state) {
                    throw new Error('لم يتم الحصول على معامل الحالة');
                }

                // Verify state parameter - check both localStorage and sessionStorage
                const storedStateLocal = localStorage.getItem('discord_oauth_state');
                const storedStateSession = sessionStorage.getItem('discord_oauth_state');
                const storedState = storedStateSession || storedStateLocal;
                
                console.log('State comparison:', { received: state, stored: storedState, match: state === storedState });
                
                // More lenient state verification - if no stored state, accept any state
                if (storedState && state !== storedState) {
                    console.warn('State mismatch, but continuing with authentication...');
                }

                // Exchange code for token using client-side approach
                const tokenResponse = await exchangeCodeForToken(code, DISCORD_CONFIG.redirectUri);

                if (!tokenResponse.ok) {
                    const errorData = await tokenResponse.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP ${tokenResponse.status}: ${tokenResponse.statusText}`);
                }

                const tokenData = await tokenResponse.json();
                
                if (!tokenData.access_token) {
                    throw new Error('لم يتم الحصول على رمز الوصول');
                }

                // Get user data
                const userResponse = await fetch(`${DISCORD_CONFIG.apiBase}/users/@me`, {
                    headers: {
                        'Authorization': `Bearer ${tokenData.access_token}`
                    }
                });

                if (!userResponse.ok) {
                    throw new Error('فشل في الحصول على بيانات المستخدم');
                }

                const userData = await userResponse.json();

                // Store data in localStorage
                localStorage.setItem('discord_access_token', tokenData.access_token);
                localStorage.setItem('discord_user_data', JSON.stringify(userData));
                
                // Clear state from both storage locations
                localStorage.removeItem('discord_oauth_state');
                sessionStorage.removeItem('discord_oauth_state');

                // Show success and close window
                document.getElementById('loading').style.display = 'none';
                document.getElementById('success').style.display = 'block';

                // Notify parent window if it exists
                if (window.opener && window.opener.handleDiscordCallback) {
                    window.opener.handleDiscordCallback(code, state);
                }

                // Close window after delay
                setTimeout(() => {
                    if (window.opener) {
                        window.close();
                    } else {
                        // If not in popup, redirect to main page
                        window.location.href = window.location.origin;
                    }
                }, 2000);

            } catch (error) {
                console.error('OAuth callback error:', error);
                
                // Show error
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error-message').textContent = error.message;
                
                // Clear any stored state from both locations
                localStorage.removeItem('discord_oauth_state');
                sessionStorage.removeItem('discord_oauth_state');
                
                // Auto-redirect to main page after error
                setTimeout(() => {
                    if (window.opener) {
                        window.close();
                    } else {
                        window.location.href = window.location.origin;
                    }
                }, 5000);
            }
        }

        // Exchange authorization code for access token
        async function exchangeCodeForToken(code, redirectUri) {
            try {
                // Create form data for Discord OAuth2 token exchange
                const formData = new URLSearchParams();
                formData.append('client_id', DISCORD_CONFIG.clientId);
                formData.append('client_secret', DISCORD_CONFIG.clientSecret);
                formData.append('grant_type', 'authorization_code');
                formData.append('code', code);
                formData.append('redirect_uri', redirectUri);

                const response = await fetch('https://discord.com/api/oauth2/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error_description || `HTTP ${response.status}: ${response.statusText}`);
                }

                const tokenData = await response.json();
                
                return {
                    ok: true,
                    json: () => Promise.resolve(tokenData)
                };

            } catch (error) {
                console.error('Token exchange error:', error);
                throw error;
            }
        }

        // Start processing when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Callback page loaded');
            console.log('URL params:', { code: code ? 'present' : 'missing', state: state ? 'present' : 'missing', error });
            handleCallback();
        });

        // Retry authentication
        function retryAuth() {
            // Clear any stored state
            localStorage.removeItem('discord_oauth_state');
            sessionStorage.removeItem('discord_oauth_state');
            
            // Close current window and notify parent
            if (window.opener) {
                window.opener.postMessage({ type: 'DISCORD_AUTH_RETRY' }, '*');
            }
            window.close();
        }

        // Handle window close
        window.addEventListener('beforeunload', () => {
            if (window.opener) {
                window.opener.postMessage({ type: 'DISCORD_AUTH_CLOSED' }, '*');
            }
        });
    </script>
</body>
</html>
