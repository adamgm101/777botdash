<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Discord Authentication - معالجة المصادقة</title>
    <style>
        body {
            font-family: 'Cairo', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #0a0d12 0%, #1a1f2e 100%);
            color: #e6f1ff;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .callback-container {
            text-align: center;
            padding: 40px;
            background: rgba(15, 20, 27, 0.95);
            border-radius: 20px;
            border: 1px solid #1b2433;
            backdrop-filter: blur(20px);
            max-width: 400px;
            width: 90%;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #1b2433;
            border-top: 4px solid #00e5ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        h2 {
            color: #e6f1ff;
            margin-bottom: 16px;
        }
        
        p {
            color: #93a4bf;
            margin-bottom: 20px;
        }
        
        .error {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .success {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
    </style>
</head>
<body>
    <div class="callback-container">
        <div id="loading" class="loading-state">
            <div class="spinner"></div>
            <h2>جاري معالجة المصادقة...</h2>
            <p>يرجى الانتظار بينما نعالج تسجيل الدخول الخاص بك</p>
        </div>
        
        <div id="error" class="error-state" style="display: none;">
            <h2>❌ فشل في المصادقة</h2>
            <p id="error-message">حدث خطأ أثناء تسجيل الدخول</p>
            <button onclick="window.close()" style="
                background: #ef4444;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                margin-top: 16px;
            ">إغلاق النافذة</button>
        </div>
        
        <div id="success" class="success-state" style="display: none;">
            <h2>✅ تم تسجيل الدخول بنجاح</h2>
            <p>سيتم إغلاق هذه النافذة تلقائياً</p>
        </div>
    </div>

    <script>
        // Discord OAuth2 Configuration (should match main app)
        const DISCORD_CONFIG = {
            clientId: '1399499840475500574', // Client ID الخاص بك
            clientSecret: 'P7RHo2yhr0Is2Yc5gPf78Odlgtkj0N7f', // Client Secret الخاص بك
            redirectUri: 'http://localhost:3000/callback.html', // يجب أن يطابق ما هو مسجل في Discord Developer Portal
            scopes: ['identify', 'guilds'],
            apiBase: 'https://discord.com/api/v10'
        };

        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const error = urlParams.get('error');
        const errorDescription = urlParams.get('error_description');

        // Handle OAuth callback
        async function handleCallback() {
            try {
                // Check for OAuth errors
                if (error) {
                    throw new Error(errorDescription || error);
                }

                if (!code) {
                    throw new Error('لم يتم الحصول على رمز المصادقة');
                }

                if (!state) {
                    throw new Error('لم يتم الحصول على معامل الحالة');
                }

                // Verify state parameter
                const storedState = localStorage.getItem('discord_oauth_state');
                if (state !== storedState) {
                    throw new Error('معامل الحالة غير صحيح');
                }

                // Exchange code for token
                const tokenResponse = await fetch('/api/discord/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: code,
                        redirect_uri: DISCORD_CONFIG.redirectUri
                    })
                });

                if (!tokenResponse.ok) {
                    const errorData = await tokenResponse.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP ${tokenResponse.status}: ${tokenResponse.statusText}`);
                }

                const tokenData = await tokenResponse.json();
                
                if (!tokenData.access_token) {
                    throw new Error('لم يتم الحصول على رمز الوصول');
                }

                // Get user data
                const userResponse = await fetch(`${DISCORD_CONFIG.apiBase}/users/@me`, {
                    headers: {
                        'Authorization': `Bearer ${tokenData.access_token}`
                    }
                });

                if (!userResponse.ok) {
                    throw new Error('فشل في الحصول على بيانات المستخدم');
                }

                const userData = await userResponse.json();

                // Store data in localStorage
                localStorage.setItem('discord_access_token', tokenData.access_token);
                localStorage.setItem('discord_user_data', JSON.stringify(userData));
                localStorage.removeItem('discord_oauth_state');

                // Show success and close window
                document.getElementById('loading').style.display = 'none';
                document.getElementById('success').style.display = 'block';

                // Notify parent window
                if (window.opener && window.opener.handleDiscordCallback) {
                    window.opener.handleDiscordCallback(code, state);
                }

                // Close window after delay
                setTimeout(() => {
                    window.close();
                }, 2000);

            } catch (error) {
                console.error('OAuth callback error:', error);
                
                // Show error
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error-message').textContent = error.message;
                
                // Clear any stored state
                localStorage.removeItem('discord_oauth_state');
            }
        }

        // Start processing when page loads
        document.addEventListener('DOMContentLoaded', handleCallback);

        // Handle window close
        window.addEventListener('beforeunload', () => {
            if (window.opener) {
                window.opener.postMessage({ type: 'DISCORD_AUTH_CLOSED' }, '*');
            }
        });
    </script>
</body>
</html>
